{"version":3,"file":"pinia.js","sources":["../../src/pinia.ts"],"sourcesContent":["import { addBreadcrumb, getClient, getCurrentScope, getGlobalScope } from '@sentry/core';\nimport { addNonEnumerableProperty } from '@sentry/utils';\n\n// Inline PiniaPlugin type\ntype PiniaPlugin = (context: {\n  store: {\n    $id: string;\n    $state: unknown;\n    $onAction: (callback: (context: { name: string; after: (callback: () => void) => void }) => void) => void;\n  };\n}) => void;\n\ntype SentryPiniaPluginOptions = {\n  attachPiniaState?: boolean;\n  addBreadcrumbs?: boolean;\n  actionTransformer?: (action: any) => any;\n  stateTransformer?: (state: any) => any;\n};\n\nexport const createSentryPiniaPlugin: (options?: SentryPiniaPluginOptions) => PiniaPlugin = (\n  options: SentryPiniaPluginOptions = {\n    attachPiniaState: true,\n    addBreadcrumbs: true,\n    actionTransformer: action => action,\n    stateTransformer: state => state,\n  },\n) => {\n  const plugin: PiniaPlugin = ({ store }) => {\n    options.attachPiniaState !== false &&\n      getGlobalScope().addEventProcessor((event, hint) => {\n        try {\n          // Get current timestamp in hh:mm:ss\n          const timestamp = new Date().toTimeString().split(' ')[0];\n          const filename = `pinia_state_${store.$id}_${timestamp}.json`;\n\n          hint.attachments = [\n            ...(hint.attachments || []),\n            {\n              filename,\n              data: JSON.stringify(store.$state),\n            },\n          ];\n        } catch (_) {\n          // empty\n        }\n\n        return event;\n      });\n\n    store.$onAction(context => {\n      context.after(() => {\n        const transformedActionName = options.actionTransformer\n          ? options.actionTransformer(context.name)\n          : context.name;\n\n        if (\n          typeof transformedActionName !== 'undefined' &&\n          transformedActionName !== null &&\n          options.addBreadcrumbs !== false\n        ) {\n          addBreadcrumb({\n            category: 'action',\n            message: transformedActionName,\n            level: 'info',\n          });\n        }\n\n        /* Set latest state to scope */\n        const transformedState = options.stateTransformer ? options.stateTransformer(store.$state) : store.$state;\n        const scope = getCurrentScope();\n        const currentState = scope.getScopeData().contexts.state;\n\n        if (typeof transformedState !== 'undefined' && transformedState !== null) {\n          const client = getClient();\n          const options = client && client.getOptions();\n          const normalizationDepth = (options && options.normalizeDepth) || 3; // default state normalization depth to 3\n          const piniaStateContext = { type: 'pinia', value: transformedState };\n\n          const newState = {\n            ...(currentState || {}),\n            state: piniaStateContext,\n          };\n\n          addNonEnumerableProperty(\n            newState,\n            '__sentry_override_normalization_depth__',\n            3 + // 3 layers for `state.value.transformedState\n              normalizationDepth, // rest for the actual state\n          );\n\n          scope.setContext('state', newState);\n        } else {\n          scope.setContext('state', {\n            ...(currentState || {}),\n            state: { type: 'pinia', value: 'undefined' },\n          });\n        }\n      });\n    });\n  };\n\n  return plugin;\n};\n"],"names":["getGlobalScope","addBreadcrumb","getCurrentScope","getClient","addNonEnumerableProperty"],"mappings":"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"}